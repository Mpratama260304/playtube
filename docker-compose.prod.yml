# ============================================
# PlayTube Production Docker Compose
# Optimized for video streaming performance
# ============================================

version: '3.9'

services:
  # ==========================================
  # Nginx (Web Server & Reverse Proxy)
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: playtube-nginx
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - playtube-storage:/var/www/storage
      - ./public:/var/www/public:ro
    depends_on:
      - app
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # PHP-FPM Application
  # ==========================================
  app:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-app
    restart: unless-stopped
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      - APP_URL=${APP_URL}
      
      # Database
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD}
      
      # Queue & Cache
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      # Video Delivery
      - VIDEO_DELIVERY_DRIVER=nginx
      - VIDEO_GENERATE_THUMBNAIL=true
      
      # Storage
      - FILESYSTEM_DISK=public
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      - db
      - redis
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "php", "artisan", "tinker", "--execute=echo 'ok'"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Queue Worker (High Priority)
  # Handles video processing jobs
  # ==========================================
  worker-high:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-worker-high
    restart: unless-stopped
    command: php artisan queue:work redis --queue=high --sleep=1 --tries=3 --timeout=3600
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      - APP_URL=${APP_URL}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD}
      - QUEUE_CONNECTION=redis
      - REDIS_HOST=redis
      - VIDEO_DELIVERY_DRIVER=nginx
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      - app
      - redis
    networks:
      - playtube-network

  # ==========================================
  # Queue Worker (Default Priority)
  # Handles general background jobs
  # ==========================================
  worker-default:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-worker-default
    restart: unless-stopped
    command: php artisan queue:work redis --queue=default,low --sleep=3 --tries=3 --timeout=1800
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      - APP_URL=${APP_URL}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD}
      - QUEUE_CONNECTION=redis
      - REDIS_HOST=redis
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      - app
      - redis
    networks:
      - playtube-network

  # ==========================================
  # Redis (Cache & Queue)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: playtube-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - playtube-redis:/data
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # MariaDB Database
  # ==========================================
  db:
    image: mariadb:11
    container_name: playtube-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=${DB_DATABASE:-playtube}
      - MYSQL_USER=${DB_USERNAME:-playtube}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    volumes:
      - playtube-db:/var/lib/mysql
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 3

# ==========================================
# Networks
# ==========================================
networks:
  playtube-network:
    driver: bridge

# ==========================================
# Persistent Volumes
# ==========================================
volumes:
  playtube-storage:
    driver: local
  playtube-logs:
    driver: local
  playtube-redis:
    driver: local
  playtube-db:
    driver: local
