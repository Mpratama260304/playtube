# ============================================
# PlayTube Production Docker Compose
# Optimized for video streaming performance
# Updated: Phala Cloud deployment fixes
# NOTE: App image bundles nginx + php-fpm via supervisord
# ============================================

services:
  # ==========================================
  # Laravel Application (nginx + php-fpm bundled)
  # ==========================================
  app:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-app
    restart: unless-stopped
    # IMPORTANT: Literal port for Phala Cloud endpoint detection
    # Phala creates public URL: https://<app-id>-8080.dstack-prod5.phala.network
    ports:
      - "8080:80"
    # Override command to ensure nginx listens on 0.0.0.0:80 (not 127.0.0.1)
    command:
      - /bin/sh
      - -c
      - |
        echo "==> Patching nginx to listen on all interfaces..."
        for conf in /etc/nginx/http.d/*.conf /etc/nginx/conf.d/*.conf /etc/nginx/nginx.conf; do
          if [ -f "$$conf" ]; then
            sed -i 's/listen 127\.0\.0\.1:80/listen 80/g' "$$conf" 2>/dev/null || true
            sed -i 's/listen localhost:80/listen 80/g' "$$conf" 2>/dev/null || true
          fi
        done
        echo "==> Starting application..."
        exec /usr/local/bin/start.sh
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      # APP_URL: Set to actual Phala endpoint after deployment
      # e.g., https://<app-id>-8080.dstack-prod5.phala.network
      - APP_URL=${APP_URL:-http://localhost}
      
      # Proxy & HTTPS (for Phala Cloud / reverse proxy)
      # Phala gateway handles TLS, app trusts X-Forwarded-* headers
      - TRUSTED_PROXIES=${TRUSTED_PROXIES:-*}
      # Disable forced HTTPS until endpoint is confirmed working
      - FORCE_HTTPS=${FORCE_HTTPS:-false}
      
      # Database (force mysql, not sqlite)
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD:-change_this_db_password}
      
      # Queue & Cache (all Redis)
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - CACHE_STORE=redis
      - SESSION_DRIVER=redis
      - SESSION_SECURE_COOKIE=${SESSION_SECURE_COOKIE:-false}
      - REDIS_CLIENT=phpredis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      
      # Video Delivery
      - VIDEO_DELIVERY_DRIVER=nginx
      - VIDEO_GENERATE_THUMBNAIL=true
      - VIDEO_SERVER_URL=${VIDEO_SERVER_URL:-http://video-server:8090}
      
      # Storage
      - FILESYSTEM_DISK=public
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      video-server:
        condition: service_healthy
    networks:
      - playtube-network
    healthcheck:
      # HTTP healthcheck - verifies nginx is accepting connections
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:80/health >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      start_period: 120s
      retries: 10

  # ==========================================
  # Queue Worker (High Priority)
  # Handles video processing jobs
  # ==========================================
  worker-high:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-worker-high
    restart: unless-stopped
    command: php artisan queue:work redis --queue=high --sleep=1 --tries=3 --timeout=3600
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      - APP_URL=${APP_URL}
      # Force mysql connection
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD:-change_this_db_password}
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - CACHE_STORE=redis
      - REDIS_CLIENT=phpredis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - VIDEO_DELIVERY_DRIVER=nginx
      - VIDEO_SERVER_URL=${VIDEO_SERVER_URL:-http://video-server:8090}
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      video-server:
        condition: service_healthy
    networks:
      - playtube-network

  # ==========================================
  # Queue Worker (Default Priority)
  # Handles general background jobs
  # ==========================================
  worker-default:
    image: ${DOCKER_IMAGE:-mpratamamail/playtube:latest}
    container_name: playtube-worker-default
    restart: unless-stopped
    command: php artisan queue:work redis --queue=default,low --sleep=3 --tries=3 --timeout=1800
    environment:
      - APP_NAME=${APP_NAME:-PlayTube}
      - APP_ENV=production
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=false
      - APP_URL=${APP_URL}
      # Force mysql connection
      - DB_CONNECTION=mysql
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-playtube}
      - DB_USERNAME=${DB_USERNAME:-playtube}
      - DB_PASSWORD=${DB_PASSWORD:-change_this_db_password}
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - CACHE_STORE=redis
      - REDIS_CLIENT=phpredis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - VIDEO_SERVER_URL=${VIDEO_SERVER_URL:-http://video-server:8090}
    volumes:
      - playtube-storage:/var/www/html/storage
      - playtube-logs:/var/www/html/storage/logs
    depends_on:
      app:
        condition: service_healthy
      redis:
        condition: service_healthy
      video-server:
        condition: service_healthy
    networks:
      - playtube-network

  # ==========================================
  # Go Video Streaming Server (High Performance)
  # Handles video streaming for regular videos and shorts
  # NOTE: Internal only - no host port binding (accessed via docker network)
  # ==========================================
  video-server:
    image: ${VIDEO_SERVER_IMAGE:-mpratamamail/playtube-video-server:latest}
    container_name: playtube-video-server
    restart: unless-stopped
    # No ports exposed to host - internal network only
    # App/workers access via http://video-server:8090
    environment:
      - VIDEO_SERVER_PORT=8090
      - VIDEO_BASE_PATH=/data/videos
      - HLS_BASE_PATH=/data/hls
      - VIDEO_SECRET_KEY=${GO_VIDEO_SECRET_KEY:-playtube-video-secret-key-change-in-production}
      - VIDEO_CACHE_SIZE=${VIDEO_CACHE_SIZE:-1073741824}
      - VIDEO_CACHE_ENABLED=${VIDEO_CACHE_ENABLED:-true}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - APP_ENV=${APP_ENV:-production}
    volumes:
      - playtube-storage:/data
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8090/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 10

  # ==========================================
  # Redis (Cache & Queue)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: playtube-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - playtube-redis:/data
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 5

  # ==========================================
  # MariaDB Database
  # ==========================================
  db:
    image: mariadb:11
    container_name: playtube-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=${DB_DATABASE:-playtube}
      - MYSQL_USER=${DB_USERNAME:-playtube}
      # IMPORTANT: Non-empty defaults to prevent startup failure
      - MYSQL_PASSWORD=${DB_PASSWORD:-change_this_db_password}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-change_this_root_password}
    volumes:
      - playtube-db:/var/lib/mysql
    networks:
      - playtube-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      start_period: 90s
      retries: 10

# ==========================================
# Networks
# ==========================================
networks:
  playtube-network:
    driver: bridge

# ==========================================
# Persistent Volumes
# ==========================================
volumes:
  playtube-storage:
    driver: local
  playtube-logs:
    driver: local
  playtube-redis:
    driver: local
  playtube-db:
    driver: local
